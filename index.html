<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Level Up! ì˜ë‹¨ì–´</title>
  <!-- Tailwind Play CDN (ê°„í¸ ë°°í¬ìš©) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* í”Œë˜ì‹œì¹´ë“œ ë’¤ì§‘ê¸° */
    .flip { perspective: 1200px; }
    .flip-inner { transition: transform .5s; transform-style: preserve-3d; }
    .flip.flipped .flip-inner { transform: rotateY(180deg); }
    .flip-face { backface-visibility: hidden; }
    .flip-back { transform: rotateY(180deg); }
  </style>
  <!-- PapaParse: CSV íŒŒì„œ -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-100 via-pink-100 to-yellow-100 text-gray-800">

  <!-- ë£¨íŠ¸ -->
  <div id="app" class="p-6"></div>

  <script>
  const $ = (sel, el=document) => el.querySelector(sel)
  const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel))

  // ===== ì˜¤ë””ì˜¤ íš¨ê³¼ =====
  function chime(){ try{ const AC=window.AudioContext||window.webkitAudioContext; const ctx=new AC(); const o=ctx.createOscillator(); const g=ctx.createGain(); o.type='sine'; o.connect(g); g.connect(ctx.destination); const t=ctx.currentTime; g.gain.setValueAtTime(0.0001,t); g.gain.exponentialRampToValueAtTime(0.25,t+0.01); o.frequency.setValueAtTime(1200,t); o.frequency.setValueAtTime(1600,t+0.08); o.frequency.setValueAtTime(2000,t+0.16); g.gain.exponentialRampToValueAtTime(0.0001,t+0.34); o.start(t); o.stop(t+0.36); setTimeout(()=>ctx.close(),500);}catch(e){} }
  function ding(){ try{ const AC=window.AudioContext||window.webkitAudioContext; const ctx=new AC(); const o=ctx.createOscillator(); const g=ctx.createGain(); o.type='sine'; o.frequency.value=880; o.connect(g); g.connect(ctx.destination); g.gain.setValueAtTime(0.0001,ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.2,ctx.currentTime+0.01); g.gain.exponentialRampToValueAtTime(0.0001,ctx.currentTime+0.25); o.start(); o.stop(ctx.currentTime+0.27); setTimeout(()=>ctx.close(),400);}catch(e){} }
  /* â”€â”€ ì˜¤ë‹µ "ë•¡!" */
function buzz(){ 
  try{
    const AC=window.AudioContext||window.webkitAudioContext; 
    const ctx=new AC();
    const o=ctx.createOscillator(); const g=ctx.createGain();
    o.type='square'; o.connect(g); g.connect(ctx.destination);
    const t=ctx.currentTime;
    g.gain.setValueAtTime(0.0001,t);
    g.gain.exponentialRampToValueAtTime(0.22,t+0.01);
    o.frequency.setValueAtTime(320,t);
    o.frequency.exponentialRampToValueAtTime(120,t+0.25); /* ë‚´ë ¤ê°€ëŠ” ìŒ */
    g.gain.exponentialRampToValueAtTime(0.0001,t+0.28);
    o.start(t); o.stop(t+0.30);
    setTimeout(()=>ctx.close(),400);
  }catch(e){}
}

/* â”€â”€ ìµœì¢… ê²°ê³¼ "ë¹ ë°©"(ê°„ë‹¨í•œ íŒ¡íŒŒë¥´) */
function fanfare(){
  try{
    const AC=window.AudioContext||window.webkitAudioContext; 
    const ctx=new AC();
    const g=ctx.createGain(); g.connect(ctx.destination);
    const t=ctx.currentTime;
    g.gain.setValueAtTime(0.0001,t);
    g.gain.exponentialRampToValueAtTime(0.28,t+0.02);

    /* Câ€“Eâ€“Gâ€“High C ìˆœì°¨ ìš¸ë¦¼ */
    [523.25,659.25,783.99,1046.5].forEach((f,i)=>{
      const o=ctx.createOscillator(); o.type='sine'; o.frequency.value=f;
      o.connect(g); o.start(t+0.06*i); o.stop(t+0.65);
    });
    g.gain.exponentialRampToValueAtTime(0.0001,t+0.8);
    setTimeout(()=>ctx.close(),1000);
  }catch(e){}
}
    function speak(text){ if(!text) return; const u=new SpeechSynthesisUtterance(text); u.lang='en-US'; u.rate=0.95; window.speechSynthesis.cancel(); window.speechSynthesis.speak(u) }

  // ===== ë°ì´í„°(ëŸ°íƒ€ì„ ë¡œë”©) =====
  const dataset = { '3': {}, '4': {}, '5': {}, '6': {} } // {grade: {unitKey: [words]}}
  const dicts   = { '3': {}, '4': {}, '5': {}, '6': {} } // {grade: {word: {kr,ex,exKr}}}

  function parseUnitNumber(lesson){
    if(!lesson) return null
    const m = String(lesson).match(/(Lesson|Unit)\s*(\d{1,2})/i)
    return m ? Number(m[2]) : null
  }

  async function loadCsvForGrade(grade){
    const url = `./${grade}g.csv`
    const resp = await fetch(url)
    if(!resp.ok){ console.warn('CSV ë¡œë“œ ì‹¤íŒ¨', url); return [] }
    const text = await resp.text()
    const parsed = Papa.parse(text, { header:true, delimiter:';', skipEmptyLines:true })
    if(parsed.errors?.length){ console.warn('CSV parse errors', parsed.errors) }
    return parsed.data || []
  }

  async function loadAll(){
    for(const g of ['3','4','5','6']){
      const rows = await loadCsvForGrade(g)
      const unitMap = {}
      rows.forEach(r=>{
        const w = r['ì˜ë‹¨ì–´']?.trim()
        const kr = r['ëœ»']?.trim()
        const ex = r['ì˜ˆë¬¸']?.trim()
        const exKr= r['í•´ì„']?.trim()
        const uNum = parseUnitNumber(r['ë‹¨ì›ëª…'])
        if(!w || !kr || !uNum) return
        const key = String(uNum)
        unitMap[key] ||= []
        if(!unitMap[key].includes(w)) unitMap[key].push(w)
        if(!dicts[g][w]) dicts[g][w] = { kr, ex: ex||`I see a ${w}.`, exKr: exKr||'(í•´ì„ ì¤€ë¹„ì¤‘)' }
      })
      dataset[g] = unitMap
    }
  }

  // ===== ìƒíƒœ =====
  let state = {
    loading: true,
    started: false,
    mode: 'menu', // 'menu' | 'study' | 'fill' | 'match' | 'quiz'
    grade: '',    // '3' | '4' | '5' | '6'
    unit: '',     // '1' | ...
  }

  function setState(patch){ state = {...state, ...patch}; render() }

  function words(){ const {grade,unit}=state; return (grade && unit) ? (dataset[grade]?.[unit]||[]) : [] }
  function dict(){ const {grade}=state; return grade? dicts[grade] : {} }
  function availableUnits(){ const {grade}=state; return grade? Object.keys(dataset[grade]||{}).sort((a,b)=>Number(a)-Number(b)) : [] }

  // ===== UI ë¹Œë” =====
  function btn(cls, text, on){ const b=document.createElement('button'); b.className=cls; b.textContent=text; if(on) b.onclick=on; return b }
  function card(cls){ const d=document.createElement('div'); d.className='rounded-2xl bg-white/85 backdrop-blur shadow-lg '+(cls||''); return d }

  function ScreenLoading(){
    const wrap=document.createElement('div')
    wrap.className='min-h-screen grid place-items-center p-6'
    wrap.innerHTML=`<div class="text-center">
      <div class="text-3xl font-extrabold text-purple-700">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
      <div class="text-gray-600 mt-2">3g.csv, 4g.csv, 5g.csv, 6g.csv</div>
    </div>`
    return wrap
  }

  function ScreenStart(){
    const outer=document.createElement('div')
    outer.className='flex flex-col items-center justify-center min-h-screen p-6'

    const c=card('w-full max-w-xl')
    const inner=document.createElement('div'); inner.className='p-6 flex flex-col items-center space-y-6'
    c.appendChild(inner)

    const h=document.createElement('h1')
    h.className='text-4xl font-extrabold text-purple-600 drop-shadow-sm text-center'
    h.textContent='Level Up! ì˜ë‹¨ì–´!'

    const p=document.createElement('p')
    p.className='text-center text-gray-700 text-base'
    p.innerHTML='í•™ë…„ê³¼ ë‹¨ì›ì„ ê³ ë¥´ê³  <span class="font-semibold text-purple-500">í•™ìŠµ ì‹œì‘</span> ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.'

    const grid=document.createElement('div')
    grid.className='w-full grid grid-cols-1 md:grid-cols-2 gap-4'

    // ì¢Œì¸¡ í¼
    const form=document.createElement('div'); form.className='space-y-4'
    const selG=document.createElement('select')
    selG.className='w-full rounded-xl border border-gray-300 bg-white px-3 py-2 shadow-sm'
    selG.innerHTML='<option value="" disabled>í•™ë…„ ì„ íƒ</option>\
      <option value="3">3í•™ë…„</option>\
      <option value="4">4í•™ë…„</option>\
      <option value="5">5í•™ë…„</option>\
      <option value="6">6í•™ë…„</option>'
    if(state.grade){ selG.value = state.grade } else { selG.selectedIndex = 0 }
    selG.onchange=(e)=>{ setState({ grade: e.target.value, unit:'' }) }

    const selU=document.createElement('select')
    selU.className='w-full rounded-xl border border-gray-300 bg-white px-3 py-2 shadow-sm'
    selU.disabled = !state.grade

    function refreshUnits(){
      selU.innerHTML='<option value="" disabled>ë‹¨ì› ì„ íƒ</option>'
      if(!state.grade){ selU.disabled=true; return }
      selU.disabled=false
      for(const u of availableUnits()){
        const o=document.createElement('option'); o.value=u; o.textContent=`${u}ë‹¨ì›`; selU.appendChild(o)
      }
      if(state.unit){ selU.value = state.unit } else { selU.selectedIndex = 0 }
    }
    refreshUnits()
    selU.onchange=(e)=> setState({ unit: e.target.value })

    const startBtn = btn('w-full text-lg rounded-xl py-3 bg-purple-500 hover:bg-purple-600 text-white disabled:opacity-60 disabled:cursor-not-allowed', 'í•™ìŠµ ì‹œì‘ âœ¨', ()=>{ setState({started:true, mode:'menu'}) })
    startBtn.disabled = !(state.grade && state.unit)

    const selectedInfo=document.createElement('div')
    selectedInfo.className='text-sm text-gray-600'
    selectedInfo.textContent = (state.grade && state.unit) ? `ì„ íƒ: ${state.grade}í•™ë…„ ${state.unit}ë‹¨ì›` : 'í•™ë…„Â·ë‹¨ì›ì„ ì„ íƒí•˜ì„¸ìš”'

    form.append(selG, selU, selectedInfo, startBtn)

    // ìš°ì¸¡ ë„ì›€ë§
    const help=document.createElement('div')
    help.className='space-y-3 bg-purple-50/60 border border-purple-200 rounded-2xl p-4'
    help.innerHTML=`<h3 class="font-bold text-purple-700">ì‚¬ìš© ì„¤ëª…ì„œ</h3>
      <ul class="text-sm text-gray-700 list-disc pl-5 space-y-1">
        <li>CSVì—ì„œ <b>ìƒˆë¡œ ë‚˜ì˜¨ ë‹¨ì–´</b>ë§Œ ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.</li>
        <li>ë©”ë‰´ì—ì„œ <b>ë‹¨ì–´ í•™ìŠµ / ë‹¨ì–´ ë§ì¶”ê¸° / ë¹ˆ ì¹¸ ì±„ìš°ê¸° / ì§ ë§ì¶”ê¸°</b>ë¥¼ ê³ ë¥´ì„¸ìš”.</li>
        <li>í”Œë˜ì‹œì¹´ë“œëŠ” ì•ë©´(ë‹¨ì–´+ë°œìŒ) / ë’·ë©´(ëœ»+ì˜ˆë¬¸/í•´ì„)ìœ¼ë¡œ ê³µë¶€í•´ìš”.</li>
      </ul>`

    grid.append(form, help)
    inner.append(h, p, grid)
    outer.appendChild(c)

    const mo=new MutationObserver(()=>{ startBtn.disabled = !(state.grade && state.unit) })
    mo.observe(outer,{subtree:true, attributes:true, childList:true})

    return outer
  }

  function MenuCard({title,subtitle,emoji,onclick,gradient}){
    const b=document.createElement('button')
    b.className=`group relative overflow-hidden rounded-2xl shadow-md p-5 text-left text-white bg-gradient-to-br ${gradient}`
    b.onclick=onclick
    const row=document.createElement('div'); row.className='flex items-center gap-3 drop-shadow'
    const icon=document.createElement('div'); icon.textContent=emoji; icon.className='text-2xl'
    const texts=document.createElement('div')
    const t=document.createElement('div'); t.className='text-xl font-extrabold'; t.textContent=title
    const s=document.createElement('div'); s.className='text-sm opacity-90'; s.textContent=subtitle
    texts.append(t,s)
    row.append(icon,texts)
    b.append(row)
    return b
  }

  function ScreenMenu(){
    const outer=document.createElement('div')
    outer.className='min-h-screen w-full flex items-center justify-center bg-gradient-to-br from-pink-100 via-yellow-100 to-green-100 p-6'
    const box=document.createElement('div'); box.className='w-full max-w-4xl'
    const h=document.createElement('h1')
    h.className='text-3xl md:text-4xl font-extrabold text-purple-700 text-center drop-shadow-sm'
    h.textContent='ë¬´ì—‡ì„ í•´ë³¼ê¹Œìš”?'
    const sub=document.createElement('p')
    sub.className='text-center text-gray-700 mt-2'
    sub.textContent=`${state.grade}í•™ë…„ ${state.unit}ë‹¨ì› â€¢ ìƒˆë¡œ ë‚˜ì˜¨ ë‹¨ì–´`

    const grid=document.createElement('div'); grid.className='grid grid-cols-2 gap-4 mt-8'
    grid.append(
      MenuCard({title:'ë‹¨ì–´ í•™ìŠµ', subtitle:'í”Œë˜ì‹œì¹´ë“œë¡œ ë°°ì›Œìš”', emoji:'ğŸ“–', gradient:'from-purple-400 to-pink-400', onclick:()=>setState({mode:'study'})}),
      MenuCard({title:'ë‹¨ì–´ ë§ì¶”ê¸°', subtitle:'ëœ»ì„ ê³ ë¥´ê¸°', emoji:'ğŸ§ ', gradient:'from-sky-300 to-blue-400', onclick:()=>setState({mode:'quiz'})}),
      MenuCard({title:'ë¹ˆ ì¹¸ ì±„ìš°ê¸°', subtitle:'ê¸€ì ë¹ ì§„ ë‹¨ì–´ ë§íˆê¸°', emoji:'âœï¸', gradient:'from-amber-300 to-orange-400', onclick:()=>setState({mode:'fill'})}),
      MenuCard({title:'ì§ ë§ì¶”ê¸°', subtitle:'ë‹¨ì–´-ëœ» ì§ ë§ì¶”ê¸°', emoji:'ğŸƒ', gradient:'from-teal-300 to-emerald-400', onclick:()=>setState({mode:'match'})}),
    )

    const back=document.createElement('div'); back.className='flex justify-center mt-8'
    back.append( btn('bg-white text-gray-800 border border-gray-200 rounded-xl px-4 py-2 hover:bg-gray-50', 'í•™ë…„/ë‹¨ì› ë°”ê¾¸ê¸°', ()=>setState({started:false, mode:'menu'})) )

    box.append(h, sub, grid, back)
    outer.append(box)
    return outer
  }

  // ===== í”Œë˜ì‹œì¹´ë“œ =====
  function ScreenStudy(){
    const list = words(); const d=dict()
    if(!list.length){ return emptyScreen('ë‹¨ì–´ í•™ìŠµ Â· í”Œë˜ì‹œì¹´ë“œ', 'í•™ìŠµí•  ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.') }

    let idx=0, flipped=false
    const outer=document.createElement('div')
    outer.className='flex flex-col items-center min-h-screen bg-gradient-to-br from-purple-100 via-pink-100 to-yellow-100 p-6'

    const h=document.createElement('h2'); h.className='text-2xl md:text-3xl font-extrabold text-purple-700'; h.textContent='ë‹¨ì–´ í•™ìŠµ Â· í”Œë˜ì‹œì¹´ë“œ'
    const sub=document.createElement('p'); sub.className='text-gray-700 mt-1'; sub.textContent=titleText(idx)

    const holder=document.createElement('div'); holder.className='mt-6 w-full max-w-md'
    const flip=document.createElement('div'); flip.className='relative h-64 flip rounded-2xl'
    const flipInner=document.createElement('div'); flipInner.className='flip-inner absolute inset-0 rounded-2xl shadow-lg cursor-pointer'

    const front=document.createElement('div'); front.className='flip-face absolute inset-0 bg-white/95 rounded-2xl flex flex-col items-center justify-center gap-4 border border-purple-200'
    const wordEl=document.createElement('div'); wordEl.className='text-3xl md:text-4xl font-extrabold text-purple-700 drop-shadow-sm'
    const speakBtn=btn('bg-purple-500 hover:bg-purple-600 text-white rounded-xl px-4 py-2','ë°œìŒ ë“£ê¸°', (e)=>{ e.stopPropagation(); speak(list[idx]) })
    const hint=document.createElement('p'); hint.className='text-xs text-gray-500'; hint.textContent='(ì¹´ë“œë¥¼ íƒ­í•˜ë©´ ë’·ë©´ì´ ë³´ì—¬ìš”)'
    front.append(wordEl, speakBtn, hint)

    const back=document.createElement('div'); back.className='flip-face flip-back absolute inset-0 bg-purple-50 rounded-2xl flex flex-col items-center justify-center gap-2 border border-purple-200 p-4 text-center'
    const meaning=document.createElement('div'); meaning.className='text-lg md:text-xl font-bold text-purple-700'
    const ex=document.createElement('div'); ex.className='text-gray-700'
    const exk=document.createElement('div'); exk.className='text-gray-700'
    const hint2=document.createElement('p'); hint2.className='text-xs text-gray-500'; hint2.textContent='(ë‹¤ì‹œ íƒ­í•˜ë©´ ì•ë©´ìœ¼ë¡œ)'
    back.append(meaning, ex, exk, hint2)

    flipInner.append(front, back)
    flip.append(flipInner)
    holder.append(flip)

    function syncCard(){ const w=list[idx]; const info=d[w]||{kr:'ëœ» ì¤€ë¹„ì¤‘', ex:`I see a ${w}.`, exKr:'(í•´ì„ ì¤€ë¹„ì¤‘)'}; wordEl.textContent=w; meaning.innerHTML=`ëœ»: <span class="font-extrabold">${info.kr}</span>`; ex.innerHTML=`ì˜ˆë¬¸: <span class="font-medium">${info.ex||''}</span>`; exk.innerHTML=`í•´ì„: <span class="font-medium">${info.exKr||'(í•´ì„ ì¤€ë¹„ì¤‘)'} </span>`; sub.textContent=titleText(idx) }

    flip.addEventListener('click',()=>{ flipped=!flipped; flip.classList.toggle('flipped', flipped) })

    const nav=document.createElement('div'); nav.className='mt-6 flex items-center gap-2'
    const prev=btn('bg-white text-gray-800 border border-gray-200 rounded-xl px-4 py-2','ì´ì „',()=>{ flipped=false; flip.classList.remove('flipped'); idx=(idx-1+list.length)%list.length; syncCard() })
    const shuffle=btn('bg-transparent border border-transparent text-gray-700 rounded-xl px-4 py-2 hover:bg-gray-100','ì„ê¸°',()=>{ flipped=false; flip.classList.remove('flipped'); idx=Math.floor(Math.random()*list.length); syncCard() })
    const next=btn('bg-purple-500 hover:bg-purple-600 text-white rounded-xl px-4 py-2','ë‹¤ìŒ',()=>{ flipped=false; flip.classList.remove('flipped'); idx=(idx+1)%list.length; syncCard() })
    nav.append(prev, shuffle, next)

    const backBtnWrap=document.createElement('div'); backBtnWrap.className='flex gap-2 mt-6'
    backBtnWrap.append( btn('bg-white text-gray-800 border border-gray-200 rounded-xl px-4 py-2 hover:bg-gray-50','ë©”ë‰´ë¡œ',()=>setState({mode:'menu'})) )

    outer.append(h, sub, holder, nav, backBtnWrap)
    syncCard()
    return outer

    function titleText(i){ return `${state.grade}í•™ë…„ ${state.unit}ë‹¨ì› Â· ${list.length? i+1:0}/${list.length}` }
  }

  // ===== ë¹ˆ ì¹¸ ì±„ìš°ê¸° =====
 function ScreenFill(){
  const list=words(); const d=dict();
  if(!list.length){ return emptyScreen('ë¹ˆ ì¹¸ ì±„ìš°ê¸°','í•™ìŠµí•  ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.') }

  const pool=[...list]; for(let i=pool.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [pool[i],pool[j]]=[pool[j],pool[i]] }
  const questions=pool.slice(0, Math.min(5,pool.length))

  let qIndex=0, blankIdx=[], stage=0, filled={}, choices=[], feedback=null

  /* ì—¬ë°± ì—…ê·¸ë ˆì´ë“œ */
  const outer=document.createElement('div'); 
  outer.className='flex flex-col items-center min-h-screen bg-gradient-to-br from-amber-100 via-orange-100 to-red-100 px-6 py-10';

  const h=document.createElement('h2'); 
  h.className='text-3xl md:text-4xl font-extrabold text-amber-700';
  h.textContent='ë¹ˆ ì¹¸ ì±„ìš°ê¸°';

  const sub=document.createElement('p'); 
  sub.className='text-gray-700 mt-2 mb-8 md:mb-10';
  sub.textContent=titleText();

  const panel=card('w-full max-w-4xl bg-white/95 p-8 md:p-10 rounded-3xl shadow-lg');
  const stemWrap=document.createElement('div'); stemWrap.className='text-center';
  const stem=document.createElement('div'); stem.className='text-4xl md:text-5xl font-extrabold tracking-wider text-amber-700';
  stemWrap.append(stem);

  const infoRow=document.createElement('div'); infoRow.className='mt-8 grid grid-cols-1 md:grid-cols-3 gap-4';
  const meaningBox=document.createElement('div'); 
  meaningBox.className='md:col-span-2 rounded-xl bg-amber-50 border border-amber-200 p-4 text-amber-800';
  meaningBox.innerHTML='<div class="font-bold">ëœ»</div><div class="meaning-text"></div>';
  const meaningText=$('.meaning-text', meaningBox);
  const speakBox=document.createElement('div'); speakBox.className='flex md:justify-end items-start';
  speakBox.append( btn('bg-amber-500 hover:bg-amber-600 text-white rounded-xl px-4 py-2', 'ë°œìŒ ë“£ê¸°', ()=>speak(current())) );

  infoRow.append(meaningBox, speakBox);

  const choiceWrap=document.createElement('div'); choiceWrap.className='mt-6';
  const guide=document.createElement('div'); guide.className='text-sm text-gray-600 mb-3';
  const grid=document.createElement('div'); grid.className='grid grid-cols-5 gap-2';

  const fb=document.createElement('div');

  const nextWrap=document.createElement('div'); nextWrap.className='mt-10 flex justify-center';
  const nextBtn=btn('bg-purple-500 hover:bg-purple-600 text-white rounded-xl px-6 py-3 text-lg','ë‹¤ìŒ ë¬¸í•­', nextQuestion);

  nextWrap.append(nextBtn);

  choiceWrap.append(guide, grid, fb);
  panel.append(stemWrap, infoRow, choiceWrap, nextWrap);

  const backWrap=document.createElement('div'); backWrap.className='flex gap-2 mt-8';
  backWrap.append( btn('bg-white text-gray-800 border border-gray-200 rounded-xl px-4 py-2 hover:bg-gray-50','ë©”ë‰´ë¡œ',()=>setState({mode:'menu'})) );

  outer.append(h, sub, panel, backWrap);

  setupQuestion();
  return outer;

  function titleText(){ return `${state.grade}í•™ë…„ ${state.unit}ë‹¨ì› Â· ë¬¸í•­ ${qIndex+1}/${questions.length}` }
  function current(){ return questions[qIndex] || '' }

  function pickBlankIndices(w){
    const letters=[]; for(let i=0;i<w.length;i++) if(/[A-Za-z]/.test(w[i])) letters.push(i);
    if(!letters.length) return [];
    const pick=a=>a[Math.floor(Math.random()*a.length)];
    const i1=pick(letters); let i2=i1; if(letters.length>1){ do{i2=pick(letters)} while(i2===i1) }
    return [Math.min(i1,i2), Math.max(i1,i2)];
  }

  function makeChoices(ch){
    const alphabet='abcdefghijklmnopqrstuvwxyz'.split('');
    const correct=ch.toLowerCase();
    const pool=alphabet.filter(c=>c!==correct);
    for(let i=pool.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [pool[i],pool[j]]=[pool[j],pool[i]] }
    const picks=pool.slice(0,4);
    const all=[correct,...picks];
    for(let i=all.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [all[i],all[j]]=[all[j],all[i]] }
    return all.map(c=>c.toUpperCase());
  }

  function setupQuestion(){
    const w=current();
    const info=d[w]||{kr:'ëœ» ì¤€ë¹„ì¤‘', ex:`I see a ${w}.`};
    sub.textContent=titleText();
    blankIdx=pickBlankIndices(w); stage=0; filled={}; feedback=null;
    grid.innerHTML=''; fb.className='mt-3'; fb.textContent='';
    guide.textContent= stage===0? 'ì²« ë²ˆì§¸ ë¹ˆì¹¸ì„ ê³ ë¥´ì„¸ìš”' : 'ë‘ ë²ˆì§¸ ë¹ˆì¹¸ì„ ê³ ë¥´ì„¸ìš”';
    meaningText.textContent=info.kr;

    const mk = ()=>{
      const chars=w.split('');
      if(blankIdx.length===2){ const [b0,b1]=blankIdx; chars[b0]=filled[b0]??'_'; chars[b1]=filled[b1]??'_'; }
      return chars.join('');
    };
    stem.textContent=mk();

    if(blankIdx.length===2){ choices=makeChoices(w[blankIdx[0]]); } else { choices=[] }
    renderChoices();
    updateNextBtn();
  }

  function renderChoices(){
    grid.innerHTML='';
    choices.forEach(c=>{
      const b=btn('rounded-xl border border-amber-200 py-3 font-extrabold text-lg hover:-translate-y-0.5 hover:shadow-md hover:bg-amber-50 active:scale-[0.98] transition', c, ()=>handleChoice(c));
      grid.append(b);
    });
  }

  function handleChoice(c){
    const w=current(); if(!w||blankIdx.length!==2) return;
    const [b0,b1]=blankIdx;
    const target = stage===0? b0 : b1;
    const correct = w[target].toLowerCase();

    if(c.toLowerCase()===correct){
      filled[target]=w[target];
      ding(); /* ì •ë‹µ íš¨ê³¼ìŒ */
      fb.className='mt-3 text-green-600 font-bold'; fb.textContent='ì¢‹ì•„ìš”! ì •ë‹µì…ë‹ˆë‹¤.';
      if(stage===0){ stage=1; choices=makeChoices(w[b1]); setTimeout(()=>{ fb.textContent=''; renderChoices() }, 250) }
      else { setTimeout(()=>{ fb.textContent='' }, 300) }
      const chars=w.split(''); chars[b0]=filled[b0]??'_'; chars[b1]=filled[b1]??'_'; stem.textContent=chars.join('');
    } else {
      buzz(); /* ì˜¤ë‹µ íš¨ê³¼ìŒ */
      fb.className='mt-3 text-red-600 font-bold'; fb.textContent='ì•—! ë‹¤ì‹œ ìƒê°í•´ ë³´ì„¸ìš”.';
      setTimeout(()=>{ fb.textContent='' }, 400);
    }
    updateNextBtn();
  }

  function updateNextBtn(){
    const complete = blankIdx.length===2 && filled[blankIdx[0]] && filled[blankIdx[1]];
    nextBtn.textContent = (qIndex+1<questions.length)? 'ë‹¤ìŒ ë¬¸í•­' : 'ì™„ë£Œ (ë©”ë‰´ë¡œ)';
    nextBtn.disabled = !complete;
    nextBtn.className = 'bg-purple-500 hover:bg-purple-600 text-white rounded-xl px-6 py-3 text-lg' + (complete? '' : ' opacity-60 cursor-not-allowed');
  }

  function nextQuestion(){
    if(qIndex+1<questions.length){ qIndex++; setupQuestion(); }
    else { setState({mode:'menu'}) }
  }
}
  // ===== ë‹¨ì–´ ëœ» ë§ì¶”ê¸° =====
 function ScreenQuiz(){
  const list=words(); const d=dict();
  if(!list.length){ return emptyScreen('ë‹¨ì–´ ë§ì¶”ê¸°','í•™ìŠµí•  ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.') }

  const pool=[...list]; for(let i=pool.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [pool[i],pool[j]]=[pool[j],pool[i]] }
  const questions=pool.slice(0, Math.min(5,pool.length))

  let qIndex=0, selected=null, correct=null, finished=false, score=0;

  /* ì—¬ë°± ì—…ê·¸ë ˆì´ë“œ */
  const outer=document.createElement('div'); 
  outer.className='flex flex-col items-center min-h-screen bg-gradient-to-br from-indigo-100 via-blue-100 to-sky-100 px-6 py-10';

  const h=document.createElement('h2'); 
  h.className='text-3xl md:text-4xl font-extrabold text-indigo-700 tracking-tight';
  h.textContent='ë‹¨ì–´ ë§ì¶”ê¸°';

  const sub=document.createElement('p'); 
  sub.className='text-gray-700 mt-2 mb-8 md:mb-10';
  sub.textContent=titleText();

  const panel=card('w-full max-w-4xl bg-white/95 p-8 md:p-10 rounded-3xl shadow-lg');
  const head=document.createElement('div'); head.className='text-center';
  const wordEl=document.createElement('div'); 
  wordEl.className='text-4xl md:text-5xl font-extrabold text-indigo-700';
  const instr=document.createElement('div'); 
  instr.className='mt-3 text-base md:text-lg text-gray-500'; 
  instr.textContent='ëœ»ì„ ê³ ë¥´ì„¸ìš”';
  head.append(wordEl, instr);

  const grid=document.createElement('div'); 
  grid.className='mt-8 md:mt-10 grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-5';

  const actions=document.createElement('div'); actions.className='mt-10 flex justify-center gap-3';
  const nextBtn=btn('bg-purple-500 hover:bg-purple-600 text-white rounded-xl px-6 py-3 text-lg','ë‹¤ìŒ ë¬¸ì œ',()=>{
    if(qIndex+1<questions.length){ qIndex++; setupQ(); }
    else { finished=true; showDone(); }
  });
  const backBtn=btn('bg-white text-gray-800 border border-gray-200 rounded-xl px-6 py-3','ë©”ë‰´ë¡œ',()=>setState({mode:'menu'}));
  actions.append(nextBtn, backBtn);

  panel.append(head, grid, actions);
  outer.append(h, sub, panel);

  /* ì¤‘ì•™ íŒì—… + ì ìˆ˜ í‘œì‹œ */
  const overlay=document.createElement('div'); 
  overlay.className='fixed inset-0 hidden z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm';
  overlay.innerHTML=`<div class="bg-white rounded-2xl p-8 md:p-9 max-w-sm w-[92%] text-center shadow-2xl">
      <div class="text-2xl font-extrabold text-indigo-700">ëª¨ë‘ í’€ì—ˆì–´ìš”! ğŸ‰</div>
      <div class="mt-2 text-gray-700 result">ì •ë‹µ: 0/0</div>
      <div class="mt-5 flex gap-2 justify-center">
        <button class="again bg-purple-500 hover:bg-purple-600 text-white rounded-xl px-5 py-2.5">í•œ ë²ˆ ë”</button>
        <button class="menu bg-white text-gray-800 border border-gray-200 rounded-xl px-5 py-2.5 hover:bg-gray-50">ë©”ë‰´ë¡œ</button>
      </div>
    </div>`;
  document.body.appendChild(overlay);
  overlay.querySelector('.again').onclick=()=>{ qIndex=0; score=0; finished=false; setupQ(); overlay.classList.add('hidden') }
  overlay.querySelector('.menu').onclick=()=>{ overlay.classList.add('hidden'); setState({mode:'menu'}) }

  setupQ();
  return outer;

  function titleText(){ return `${state.grade}í•™ë…„ ${state.unit}ë‹¨ì› Â· ë¬¸í•­ ${qIndex+1}/${questions.length}` }

  function setupQ(){
    selected=null; correct=null;
    sub.textContent=titleText();
    const w=questions[qIndex];
    wordEl.textContent=w;

    const correctMeaning=d[w]?.kr || '(ëœ» ì¤€ë¹„ì¤‘)';
    const others=list.filter(x=>x!==w);
    for(let i=others.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [others[i],others[j]]=[others[j],others[i]] }
    const distractors=[];
    for(const x of others){
      const m=d[x]?.kr;
      if(m && m!==correctMeaning && !distractors.includes(m)) distractors.push(m);
      if(distractors.length>=3) break;
    }
    const options=[correctMeaning, ...distractors.slice(0,3)];
    while(options.length<4) options.push('(ë³´ê¸° ì¤€ë¹„ì¤‘)');
    for(let i=options.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [options[i],options[j]]=[options[j],options[i]] }

    grid.innerHTML='';
    options.forEach(opt=>{
      const b=btn(
        'rounded-xl border px-5 py-4 md:py-5 text-left font-semibold transition hover:-translate-y-0.5 hover:shadow-md hover:bg-indigo-50 border-indigo-200',
        opt,
        ()=>choose(opt, correctMeaning)
      );
      grid.append(b);
    });

    nextBtn.disabled=true; 
    nextBtn.classList.add('opacity-60','cursor-not-allowed');
  }

  function choose(choice, correctMeaning){
    if(correct!==null) return;
    const ok = (choice===correctMeaning);
    correct=ok;
    if(ok){ chime(); score++; } else { buzz(); }  /* â† ì˜¤ë‹µ íš¨ê³¼ìŒ */

    Array.from(grid.children).forEach(btnEl=>{
      const t=btnEl.textContent;
      btnEl.classList.remove('bg-green-50','border-green-300','text-green-700','bg-red-50','border-red-300','text-red-700');
      if(t===correctMeaning){
        btnEl.classList.add('bg-green-50','border-green-300','text-green-700')
      } else if(t===choice){
        btnEl.classList.add('bg-red-50','border-red-300','text-red-700')
      }
    });

    nextBtn.disabled=false; 
    nextBtn.classList.remove('opacity-60','cursor-not-allowed');
  }

  function showDone(){
    overlay.querySelector('.result').textContent = `ì •ë‹µ: ${score}/${questions.length}`;
    fanfare();        /* â† ìµœì¢… íŒì—… íš¨ê³¼ìŒ */
    overlay.classList.remove('hidden');
  }
}
  // ===== ì§ ë§ì¶”ê¸° =====
  function ScreenMatch(){
    const list=words(); const d=dict();
    if(!list.length || list.length<4){ return emptyScreen('ì§ ë§ì¶”ê¸°','ë‹¨ì–´ê°€ ë¶€ì¡±í•´ìš” (4ê°œ ì´ìƒ í•„ìš”)') }

    const pool=[...list]; for(let i=pool.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [pool[i],pool[j]]=[pool[j],pool[i]] }
    const selected=pool.slice(0,4)

    const deck=[]; selected.forEach((w,idx)=>{ deck.push({id:`${w}-${idx}-en`, key:w, kind:'en', label:w}); deck.push({id:`${w}-${idx}-kr`, key:w, kind:'kr', label:d[w]?.kr || '(ëœ» ì¤€ë¹„ì¤‘)'}) })
    for(let i=deck.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [deck[i],deck[j]]=[deck[j],deck[i]] }

    let flipped=[], matched=new Set(), lock=false, moves=0

    const outer=document.createElement('div'); outer.className='flex flex-col items-center min-h-screen bg-gradient-to-br from-teal-100 via-emerald-100 to-green-100 p-6'
    const h=document.createElement('h2'); h.className='text-2xl md:text-3xl font-extrabold text-emerald-700'; h.textContent='ì§ ë§ì¶”ê¸°'
    const sub=document.createElement('p'); sub.className='text-gray-700 mt-1'; sub.textContent=status()

    const grid=document.createElement('div'); grid.className='mt-5 w-full max-w-3xl grid grid-cols-2 sm:grid-cols-4 gap-3 md:gap-4'

    deck.forEach(card=>{
      const b=document.createElement('button')
      b.className='relative h-24 md:h-28 rounded-xl border shadow-sm bg-white/95 border-emerald-200 transition-transform active:scale-[0.98]'
      b.dataset.id=card.id
      b.onclick=()=>onClick(card.id)
      b.innerHTML='<div class="h-full w-full flex items-center justify-center text-emerald-700/70 text-2xl md:text-3xl font-extrabold">?</div>'
      grid.append(b)
    })

    const actions=document.createElement('div'); actions.className='mt-6 flex gap-2'
    const reshuffle=btn('bg-purple-500 hover:bg-purple-600 text-white rounded-xl px-4 py-2','ë‹¤ì‹œ ì„ê¸°',()=>{ setState({mode:'match'}) })
    const back=btn('bg-white text-gray-800 border border-gray-200 rounded-xl px-4 py-2 hover:bg-gray-50','ë©”ë‰´ë¡œ',()=>setState({mode:'menu'}) )
    actions.append(reshuffle, back)

    outer.append(h, sub, grid, actions)

    function onClick(id){ if(lock) return; if(matched.has(id)) return; if(flipped.includes(id)) return; flipped=[...flipped, id]; reveal(id, true); if(flipped.length===2){ lock=true; moves++; const [a,b]=flipped; const ca=deck.find(c=>c.id===a), cb=deck.find(c=>c.id===b); if(ca&&cb&&ca.key===cb.key&&ca.kind!==cb.kind){ chime(); setTimeout(()=>{ matched.add(a); matched.add(b); flipped=[]; lock=false; sub.textContent=status(); if(matched.size===deck.length){ const done=document.createElement('div'); done.className='mt-4 rounded-xl bg-emerald-50 border border-emerald-200 px-4 py-3 text-emerald-700 font-bold'; done.textContent='ëª¨ë‘ ë§ì·„ì–´ìš”! ğŸ¥³ ë‹¤ì‹œ í•´ë³¼ê¹Œìš”?'; outer.insertBefore(done, grid) } }, 350) } else { setTimeout(()=>{ reveal(a,false); reveal(b,false); flipped=[]; lock=false; sub.textContent=status() }, 800) } } }

    function reveal(id, show){ const btnEl = grid.querySelector(`[data-id="${id}"]`); const card = deck.find(c=>c.id===id); if(!btnEl||!card) return; if(show||matched.has(id)){ btnEl.className='relative h-24 md:h-28 rounded-xl border shadow-sm bg-emerald-50 border-emerald-300'; btnEl.innerHTML=`<div class="h-full w-full flex items-center justify-center"><div class="font-extrabold text-emerald-700 text-base md:text-lg text-center px-2 break-words leading-tight">${card.label}</div></div>` } else { btnEl.className='relative h-24 md:h-28 rounded-xl border shadow-sm bg-white/95 border-emerald-200 transition-transform active:scale-[0.98]'; btnEl.innerHTML='<div class="h-full w-full flex items-center justify-center text-emerald-700/70 text-2xl md:text-3xl font-extrabold">?</div>' } }

    function status(){ return `${state.grade}í•™ë…„ ${state.unit}ë‹¨ì› Â· ë§ì¶˜ ìŒ ${matched.size/2}/${deck.length/2} Â· ì‹œë„ ${moves}` }

    return outer
  }

  // ===== ê³µí†µ ë¹ˆ í™”ë©´ =====
  function emptyScreen(title, msg){ const outer=document.createElement('div'); outer.className='flex flex-col items-center min-h-screen p-6'; const h=document.createElement('h2'); h.className='text-2xl md:text-3xl font-extrabold text-gray-700'; h.textContent=title; const p=document.createElement('p'); p.className='text-gray-700 mt-1'; p.textContent=`${state.grade}í•™ë…„ ${state.unit}ë‹¨ì› Â· ${msg}`; const back=btn('mt-6 bg-white text-gray-800 border border-gray-200 rounded-xl px-4 py-2 hover:bg-gray-50','ë©”ë‰´ë¡œ',()=>{ state.started? setState({mode:'menu'}) : render() }); outer.append(h,p,back); return outer }

  // ===== ë¼ìš°íŒ… ë Œë” =====
  async function render(){
    const root = document.getElementById('app')
    root.innerHTML=''
    if(state.loading){ root.appendChild(ScreenLoading()); return }
    if(!state.started){ root.appendChild(ScreenStart()); return }
    if(state.mode==='menu'){ root.appendChild(ScreenMenu()); return }
    if(state.mode==='study'){ root.appendChild(ScreenStudy()); return }
    if(state.mode==='fill'){ root.appendChild(ScreenFill()); return }
    if(state.mode==='quiz'){ root.appendChild(ScreenQuiz()); return }
    if(state.mode==='match'){ root.appendChild(ScreenMatch()); return }
  }

  (async function init(){ await loadAll(); setState({loading:false}) })()
  </script>
</body>
</html>
